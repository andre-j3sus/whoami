---
import { Icon } from "astro-icon/components";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { personal } from "@/data/personal";
import { projects } from "@/data/projects";
import { skillCategories } from "@/data/skills";
import SkillBadge from "@/components/SkillBadge.astro";
import DateRange from "@/components/DateRange.astro";
import { formatYearMonth } from "@/utils/dates";

// Build a map from tech name to skill object
const techMap = new Map<string, (typeof skillCategories)[number]["skills"][number]>();
skillCategories.forEach((cat) =>
  cat.skills.forEach((s) => techMap.set(s.name, s))
);
---

<BaseLayout title={`Projects - ${personal.name}`} description={`Projects by ${personal.name}`}>
  <div class="mx-auto max-w-5xl px-6 py-16 sm:py-20">
    <div class="mb-14 animate-on-scroll">
      <h1 class="text-3xl font-bold tracking-tight">Projects</h1>
      <p class="mt-2 text-[var(--color-text-secondary)]">
        A selection of things I've built or contributed to
      </p>
    </div>

    <div class="space-y-8">
      {projects.map((project, i) => (
        <article class="glass-card p-6 sm:p-8 animate-on-scroll" data-delay={String(i + 1)}>
          <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
            <div class="flex-1">
              <h2 class="text-lg font-semibold text-[var(--color-text)]">{project.title}</h2>
              <p class="mt-1 text-sm text-[var(--color-text-muted)]">{project.subtitle}</p>
            </div>
            <div class="flex items-center gap-2">
              <span class="badge">{project.role}</span>
              <span class="badge">
                <Icon name="lucide:calendar" size={12} />
                {project.endDate || project.ongoing ? (
                  <DateRange startDate={project.startDate} endDate={project.endDate} />
                ) : (
                  <time datetime={project.startDate}>{formatYearMonth(project.startDate)}</time>
                )}
              </span>
            </div>
          </div>

          <p class="mt-4 text-sm leading-relaxed text-[var(--color-text-secondary)]">
            {project.description}
          </p>

          <!-- Tech stack with icons -->
          <div class="mt-5 flex flex-wrap gap-2">
            {project.techStack.map((tech) => {
              const skill = techMap.get(tech);
              return skill ? (
                <SkillBadge skill={skill} size="sm" />
              ) : (
                <span class="flex items-center gap-1.5 rounded-lg bg-[var(--color-bg-secondary)] px-2.5 py-1.5 text-xs text-[var(--color-text-secondary)]">
                  {tech}
                </span>
              );
            })}
          </div>

          <!-- Tags + Links -->
          <div class="mt-5 flex flex-wrap items-center gap-3">
            {project.tags.map((tag) => (
              <span class="badge">{tag}</span>
            ))}
            <span class="flex-1" />
            {project.githubUrl && (
              <a
                href={project.githubUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="btn-outline-sm"
                aria-label={`View ${project.title} on GitHub`}
              >
                <Icon name="simple-icons:github" size={14} />
                GitHub
              </a>
            )}
            {project.url && (
              <a
                href={project.url}
                target="_blank"
                rel="noopener noreferrer"
                class="btn-outline-sm"
              >
                <Icon name="lucide:external-link" size={14} />
                Website
              </a>
            )}
          </div>
        </article>
      ))}
    </div>
  </div>
</BaseLayout>
